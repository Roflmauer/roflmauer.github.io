<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan-Germany Trade & Economic Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .main-container {
            width: 80%;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .kpi-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0 30px 0;
        }
        .kpi {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            margin: 10px;
            min-width: 180px;
            flex-grow: 1;
        }
        .kpi h3 {
            margin-top: 0;
            font-size: 1em;
            color: #555;
        }
        .kpi p {
            font-size: 1.4em;
            font-weight: bold;
            color: #1A73E8;
            margin-bottom: 0;
        }
        .chart-wrapper {
            margin-bottom: 40px;
        }
        #loadingMessage, #errorMessage, .loading-economic, .error-economic {
            text-align: center;
            font-size: 1.2em;
            padding: 20px;
        }
        #errorMessage, .error-economic {
            color: red;
        }
        .economic-indicators-section {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid #ddd;
        }
        .economic-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .economic-kpi {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .economic-kpi h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
            text-align: center;
        }
        .economic-kpi-values {
            display: flex;
            justify-content: space-around;
            font-size: 1em;
        }
        .economic-kpi-values span {
            font-weight: bold;
        }
        .economic-chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        .economic-chart-container {
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Taiwan-Germany Trade & Economic Overview</h1>

        <div class="kpi-container">
            <div class="kpi">
                <h3>Latest Imports (Trade)</h3>
                <p id="latestImportValue">---</p>
            </div>
            <div class="kpi">
                <h3>Latest Exports (Trade)</h3>
                <p id="latestExportValue">---</p>
            </div>
            <div class="kpi">
                <h3>Latest Trade Balance</h3>
                <p id="latestTradeBalance">---</p>
            </div>
        </div>

        <div class="chart-wrapper">
            <h2 id="chartTitleTrade">Trade Value Over Time</h2>
            <canvas id="tradeChart"></canvas>
        </div>
        <div id="loadingMessage">Loading trade data...</div>
        <div id="errorMessage" style="display:none;"></div>

        <section class="economic-indicators-section">
            <h2>Comparative Economic Indicators: Taiwan & Germany</h2>
            <div class="loading-economic" id="loadingEconomicMessage">Loading economic data...</div>
            <div class="error-economic" id="errorEconomicMessage" style="display:none;"></div>

            <div id="economicDataContent" style="display:none;">
                <h3>Latest Available Annual Data</h3>
                <div class="economic-kpi-grid">
                    <div class="economic-kpi">
                        <h4>Real GDP Growth (%)</h4>
                        <div class="economic-kpi-values">
                            <div>Taiwan: <span id="gdp-tw-kpi">N/A</span></div>
                            <div>Germany: <span id="gdp-de-kpi">N/A</span></div>
                        </div>
                    </div>
                    <div class="economic-kpi">
                        <h4>Inflation Rate (CPI, %)</h4>
                        <div class="economic-kpi-values">
                            <div>Taiwan: <span id="inflation-tw-kpi">N/A</span></div>
                            <div>Germany: <span id="inflation-de-kpi">N/A</span></div>
                        </div>
                    </div>
                </div>

                <h3>Historical Trends (Last ~10 Years)</h3>
                <div class="economic-chart-grid">
                    <div class="economic-chart-container">
                        <canvas id="gdpChart"></canvas>
                    </div>
                    <div class="economic-chart-container">
                        <canvas id="inflationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- Configuration ---
        const TRADE_IMPORT_FILE_NAME = 'Imports_from_Germany_to_Taiwan_Over_Time.json';
        const TRADE_EXPORT_FILE_NAME = 'Exports_from_Taiwan_to_Germany_Over_Time.json';
        const TRADE_CURRENCY_SYMBOL = '$';
        const TRADE_CURRENCY_CODE = 'USD';

        const ALPHA_VANTAGE_API_KEY = "H83U1JUK9AYBAKZT"; // Your NEW personal API Key
        const AV_COUNTRY_GERMANY = "Germany";
        const AV_COUNTRY_TAIWAN = "Taiwan, Province of China"; // MODIFIED - Try this for Taiwan
        const NUMBER_OF_YEARS_ECONOMIC_DATA = 10;
        const PLACEHOLDER_API_KEY_STRING = "YOUR_ALPHA_VANTAGE_API_KEY";

        // --- Helper Functions ---
        function formatCurrency(value, symbol) {
            if (isNaN(value)) return 'N/A';
            return symbol + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatPercentage(value) {
            if (value === null || value === undefined || isNaN(parseFloat(value))) return 'N/A';
            return parseFloat(value).toFixed(2) + '%';
        }

        // --- Trade Data Functions ---
        async function fetchTradeData(fileName) {
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${fileName}`);
                }
                const jsonData = await response.json();
                const datasetKey = Object.keys(jsonData.datasets)[0];
                if (!datasetKey || !jsonData.datasets[datasetKey]) {
                    throw new Error(`Could not find data array in ${fileName} under 'datasets'.`);
                }
                return jsonData.datasets[datasetKey].map(item => ({
                    date: new Date(item.Date),
                    value: parseFloat(item.Value)
                })).sort((a, b) => a.date - b.date);
            } catch (error) {
                console.error(`Error fetching or parsing ${fileName}:`, error);
                throw error;
            }
        }

        async function displayTradeVisualizations() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            const errorMessageEl = document.getElementById('errorMessage');
            const chartTitleTradeEl = document.getElementById('chartTitleTrade');

            loadingMessageEl.style.display = 'block';
            errorMessageEl.style.display = 'none';

            try {
                const importData = await fetchTradeData(TRADE_IMPORT_FILE_NAME);
                const exportData = await fetchTradeData(TRADE_EXPORT_FILE_NAME);

                loadingMessageEl.style.display = 'none';

                if (!importData.length || !exportData.length) {
                   throw new Error("No trade data points found after processing files.");
                }

                const labels = importData.map(item => item.date);
                const importValues = importData.map(item => item.value);
                const exportValues = exportData.map(item => item.value);

                const latestImport = importData[importData.length - 1];
                const latestExport = exportData[exportData.length - 1];

                document.getElementById('latestImportValue').textContent = formatCurrency(latestImport.value, TRADE_CURRENCY_SYMBOL);
                document.getElementById('latestExportValue').textContent = formatCurrency(latestExport.value, TRADE_CURRENCY_SYMBOL);
                document.getElementById('latestTradeBalance').textContent = formatCurrency(latestExport.value - latestImport.value, TRADE_CURRENCY_SYMBOL);
                chartTitleTradeEl.textContent = `Trade Value (${TRADE_CURRENCY_CODE}) Over Time`;

                const ctx = document.getElementById('tradeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Imports from Germany',
                                data: importValues,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1,
                                fill: true,
                            },
                            {
                                label: 'Exports to Germany',
                                data: exportValues,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                tension: 0.1,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'year', tooltipFormat: 'MMM yy', displayFormats: { month: 'MMM yy', year: 'yyyy' }},
                                title: { display: true, text: 'Date' }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: `Trade Value (${TRADE_CURRENCY_CODE})` },
                                ticks: {
                                    callback: function(value) {
                                        if (Math.abs(value) >= 1e9) return TRADE_CURRENCY_SYMBOL + (value / 1e9).toFixed(1) + 'B';
                                        if (Math.abs(value) >= 1e6) return TRADE_CURRENCY_SYMBOL + (value / 1e6).toFixed(1) + 'M';
                                        return TRADE_CURRENCY_SYMBOL + value.toLocaleString('en-US');
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false, callbacks: { label: context => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y, TRADE_CURRENCY_SYMBOL)}` }},
                            legend: { position: 'top' }
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to display trade data:", error);
                loadingMessageEl.style.display = 'none';
                errorMessageEl.textContent = `Error loading trade data: ${error.message}.`;
                errorMessageEl.style.display = 'block';
            }
        }

        // --- Economic Data Functions (MODIFIED with new YoY for INFLATION and console logs) ---
        async function fetchEconomicData(indicator, country) {
            if (ALPHA_VANTAGE_API_KEY === PLACEHOLDER_API_KEY_STRING || ALPHA_VANTAGE_API_KEY === "") {
                const warningMessage = "Alpha Vantage API Key is missing or is a placeholder. Economic data will not be fetched.";
                console.warn(warningMessage);
                throw new Error("API Key Issue: " + warningMessage);
            }

            let url;
            switch (indicator) {
                case 'GDP':
                    url = `https://www.alphavantage.co/query?function=REAL_GDP&country=${country}&interval=annual&apikey=${ALPHA_VANTAGE_API_KEY}`;
                    break;
                case 'INFLATION':
                    // Even if we request annual, AlphaVantage might send monthly for CPI with some keys/countries
                    url = `https://www.alphavantage.co/query?function=CPI&country=${country}&interval=annual&apikey=${ALPHA_VANTAGE_API_KEY}`;
                    break;
                default:
                    throw new Error(`Unknown economic indicator: ${indicator}`);
            }

            console.log(`Workspaceing ${indicator} for ${country} from URL: ${url}`);

            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to fetch ${indicator} for ${country}: ${response.status} ${response.statusText}. Response: ${errorText}`);
            }
            const result = await response.json();
            console.log(`Raw API response for ${indicator} - ${country}:`, JSON.parse(JSON.stringify(result)));


            if (result.Information && result.Information.includes("API call frequency")) {
                console.warn(`Alpha Vantage API call limit likely reached for ${indicator} ${country}. Data: `, result.Information);
                throw new Error(`API Limit Reached for ${indicator} ${country}`);
            }
            if (result["Error Message"]){
                console.warn(`Alpha Vantage API error for ${indicator} ${country}: ${result["Error Message"]}`);
                throw new Error(`API Error for ${indicator} ${country}: ${result["Error Message"]}`);
            }
            if (result.Note) {
                 console.warn(`Note from Alpha Vantage for ${indicator} - ${country}: ${result.Note}`);
                 if (result.Note.toLowerCase().includes("premium") || result.Note.toLowerCase().includes("not available")) {
                    return [];
                 }
            }

            if (!result.data || result.data.length === 0) {
                console.warn(`No data array found or data array is empty for ${indicator} for ${country}. Response:`, result);
                return [];
            }

            let processedData = result.data
                .map(d => ({ date: new Date(d.date), value: parseFloat(d.value) }))
                .filter(d => !isNaN(d.value) && d.date instanceof Date && !isNaN(d.date.getFullYear()))
                .sort((a, b) => a.date - b.date);

            console.log(`Data pre-YoY calc for ${indicator} - ${country} (Count: ${processedData.length}):`, JSON.parse(JSON.stringify(processedData.slice(-5)))); // Log last 5 raw data points

            if (indicator === 'GDP') {
                if (processedData.length > 1) {
                    let yoyData = [];
                    for (let i = 1; i < processedData.length; i++) {
                        if (processedData[i-1].value !== 0 && processedData[i-1].value !== null && !isNaN(processedData[i-1].value)) {
                            const percentageChange = ((processedData[i].value - processedData[i-1].value) / processedData[i-1].value) * 100;
                            yoyData.push({ date: processedData[i].date, value: percentageChange });
                        } else {
                            yoyData.push({ date: processedData[i].date, value: null });
                        }
                    }
                    processedData = yoyData;
                } else {
                    console.warn(`Not enough data points for GDP for ${country} to calculate YoY change. Found: ${processedData.length}`);
                    processedData = [];
                }
            } else if (indicator === 'INFLATION') {
                // Check if data appears to be monthly (e.g. many more points than years covered, or interval in response is monthly)
                // For simplicity, we'll assume if result.interval === 'monthly' (from raw response) or if points > ~30 for ~10 years of data
                const isMonthly = (result.interval && result.interval.toLowerCase() === 'monthly') || (processedData.length > NUMBER_OF_YEARS_ECONOMIC_DATA + 20); // Heuristic
                if (isMonthly) {
                    console.log(`Inflation data for ${country} appears to be monthly. Calculating YoY from monthly CPI.`);
                    if (processedData.length > 12) {
                        let yoyInflationData = [];
                        for (let i = 12; i < processedData.length; i++) {
                            const currentEntry = processedData[i];
                            const prevYearEntry = processedData[i-12]; // Direct look-back for monthly

                            if (prevYearEntry && prevYearEntry.value !== 0 && prevYearEntry.value !== null && !isNaN(prevYearEntry.value)) {
                                const percentageChange = ((currentEntry.value - prevYearEntry.value) / prevYearEntry.value) * 100;
                                yoyInflationData.push({ date: currentEntry.date, value: percentageChange });
                            } else {
                                yoyInflationData.push({ date: currentEntry.date, value: null });
                            }
                        }
                        processedData = yoyInflationData;
                    } else {
                        console.warn(`Not enough monthly CPI data points for ${country} to calculate YoY inflation. Found: ${processedData.length}`);
                        processedData = [];
                    }
                } else { // Assume annual CPI, calculate YoY as with GDP
                    console.log(`Inflation data for ${country} appears to be annual. Calculating YoY from annual CPI.`);
                     if (processedData.length > 1) {
                        let yoyData = [];
                        for (let i = 1; i < processedData.length; i++) {
                            if (processedData[i-1].value !== 0 && processedData[i-1].value !== null && !isNaN(processedData[i-1].value)) {
                                const percentageChange = ((processedData[i].value - processedData[i-1].value) / processedData[i-1].value) * 100;
                                yoyData.push({ date: processedData[i].date, value: percentageChange });
                            } else {
                                yoyData.push({ date: processedData[i].date, value: null });
                            }
                        }
                        processedData = yoyData;
                    } else {
                        console.warn(`Not enough annual CPI data points for ${country} to calculate YoY inflation. Found: ${processedData.length}`);
                        processedData = [];
                    }
                }
            }

            console.log(`Final processed data for ${indicator} - ${country} (Count: ${processedData.length}):`, JSON.parse(JSON.stringify(processedData.slice(-5)))); // Log last 5 processed
            return processedData;
        }

        function createEconomicChart(canvasId, chartLabelPrefix, dataTW, dataDE) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            const yearsTW = Array.isArray(dataTW) ? dataTW.map(d => d.date.getFullYear()) : [];
            const yearsDE = Array.isArray(dataDE) ? dataDE.map(d => d.date.getFullYear()) : [];

            const allYears = [...new Set([...yearsTW, ...yearsDE])].sort((a,b) => a - b);
            // For YoY data, the first year of data might be, e.g., 1990 if raw data started in 1989.
            // We need to make sure 'limitedYears' aligns with the years present in the YoY 'processedData'.
            // The current 'limitedYears' from allYears.slice might not match perfectly if one dataset is shorter.

            // Let's use the years from the actual processed data for labels, ensuring they are common or handled.
            let chartYears = [];
            if (dataTW.length > 0 && dataDE.length > 0) {
                const allProcessedYears = [...new Set([...dataTW.map(d => d.date.getFullYear()), ...dataDE.map(d => d.date.getFullYear())])].sort((a,b) => a - b);
                chartYears = allProcessedYears.slice(-NUMBER_OF_YEARS_ECONOMIC_DATA);
            } else if (dataTW.length > 0) {
                chartYears = dataTW.map(d => d.date.getFullYear()).sort((a,b) => a - b).slice(-NUMBER_OF_YEARS_ECONOMIC_DATA);
            } else if (dataDE.length > 0) {
                chartYears = dataDE.map(d => d.date.getFullYear()).sort((a,b) => a - b).slice(-NUMBER_OF_YEARS_ECONOMIC_DATA);
            }


            const twValues = chartYears.map(year => {
                const entry = Array.isArray(dataTW) ? dataTW.find(d => d.date.getFullYear() === year) : undefined;
                return entry ? entry.value : null;
            });
            const deValues = chartYears.map(year => {
                const entry = Array.isArray(dataDE) ? dataDE.find(d => d.date.getFullYear() === year) : undefined;
                return entry ? entry.value : null;
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartYears.map(String),
                    datasets: [
                        {
                            label: `Taiwan (${chartLabelPrefix})`,
                            data: twValues,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: false,
                            spanGaps: false,
                        },
                        {
                            label: `Germany (${chartLabelPrefix})`,
                            data: deValues,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            fill: false,
                            spanGaps: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Year' }
                        },
                        y: {
                            title: { display: true, text: 'Value (%)' },
                            ticks: { callback: value => formatPercentage(value) }
                        }
                    },
                    plugins: {
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: context => `${context.dataset.label || ''}: ${formatPercentage(context.parsed.y)}` } },
                        legend: { position: 'top' }
                    }
                }
            });
        }

        async function displayEconomicIndicators() {
            const loadingEconomicEl = document.getElementById('loadingEconomicMessage');
            const errorEconomicEl = document.getElementById('errorEconomicMessage');
            const economicDataContentEl = document.getElementById('economicDataContent');

            loadingEconomicEl.style.display = 'block';
            errorEconomicEl.style.display = 'none';
            errorEconomicEl.textContent = '';
            economicDataContentEl.style.display = 'none';

            if (ALPHA_VANTAGE_API_KEY === PLACEHOLDER_API_KEY_STRING || ALPHA_VANTAGE_API_KEY === "") {
                const warningMessage = "Alpha Vantage API Key is missing or is the default placeholder. Please replace it with your personal key. Economic indicators cannot be loaded.";
                loadingEconomicEl.style.display = 'none';
                errorEconomicEl.textContent = warningMessage;
                errorEconomicEl.style.display = 'block';
                console.warn(warningMessage);
                return;
            }

            try {
                const results = await Promise.allSettled([
                    fetchEconomicData('GDP', AV_COUNTRY_TAIWAN),
                    fetchEconomicData('GDP', AV_COUNTRY_GERMANY),
                    fetchEconomicData('INFLATION', AV_COUNTRY_TAIWAN),
                    fetchEconomicData('INFLATION', AV_COUNTRY_GERMANY)
                ]);

                const gdpTW = results[0].status === 'fulfilled' ? results[0].value : [];
                const gdpDE = results[1].status === 'fulfilled' ? results[1].value : [];
                const inflationTW = results[2].status === 'fulfilled' ? results[2].value : [];
                const inflationDE = results[3].status === 'fulfilled' ? results[3].value : [];

                let hasFetchError = false;
                let specificErrorMessages = [];
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        hasFetchError = true;
                        const indicatorIndex = Math.floor(index / 2);
                        const countryIndex = index % 2;
                        const indicatorName = ['GDP', 'INFLATION'][indicatorIndex];
                        const countryName = countryIndex === 0 ? AV_COUNTRY_TAIWAN : AV_COUNTRY_GERMANY;
                        const reasonMessage = result.reason && result.reason.message ? result.reason.message : "Unknown fetch error";
                        console.error(`Failed to fetch ${indicatorName} for ${countryName}:`, result.reason);
                        if (!specificErrorMessages.includes(reasonMessage)) {
                            specificErrorMessages.push(reasonMessage);
                        }
                    }
                });

                if (hasFetchError) {
                    // Display concatenated error messages if any fetch failed
                    errorEconomicEl.textContent = `Error loading some economic data: ${specificErrorMessages.join(' | ')}. Check console.`;
                    errorEconomicEl.style.display = 'block';
                }


                loadingEconomicEl.style.display = 'none';
                economicDataContentEl.style.display = 'block';

                document.getElementById('gdp-tw-kpi').textContent = gdpTW.length ? formatPercentage(gdpTW[gdpTW.length - 1].value) : 'N/A';
                document.getElementById('gdp-de-kpi').textContent = gdpDE.length ? formatPercentage(gdpDE[gdpDE.length - 1].value) : 'N/A';
                document.getElementById('inflation-tw-kpi').textContent = inflationTW.length ? formatPercentage(inflationTW[inflationTW.length - 1].value) : 'N/A';
                document.getElementById('inflation-de-kpi').textContent = inflationDE.length ? formatPercentage(inflationDE[inflationDE.length - 1].value) : 'N/A';

                if (gdpTW.length || gdpDE.length) createEconomicChart('gdpChart', 'GDP Growth', gdpTW, gdpDE);
                else document.getElementById('gdpChart').parentElement.innerHTML = '<p class="error-economic">GDP data currently unavailable for charting.</p>';

                if (inflationTW.length || inflationDE.length) createEconomicChart('inflationChart', 'Inflation', inflationTW, inflationDE);
                else document.getElementById('inflationChart').parentElement.innerHTML = '<p class="error-economic">Inflation data currently unavailable for charting.</p>';

            } catch (error) {
                console.error("General error in displayEconomicIndicators:", error);
                loadingEconomicEl.style.display = 'none';
                 if (!errorEconomicEl.textContent || errorEconomicEl.textContent.includes("API Key Issue")) {
                    errorEconomicEl.textContent = `A general unexpected error occurred: ${error.message}. Check console.`;
                    errorEconomicEl.style.display = 'block';
                }
            }
        }

        // --- Initial Load ---
        async function initializePage() {
            await displayTradeVisualizations();
            await displayEconomicIndicators();
        }

        initializePage();
    </script>
</body>
</html>
