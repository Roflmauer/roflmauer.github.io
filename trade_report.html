<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan-Germany Trade Report - Pierre Meyer</title>
    <link href="styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    </head>
<body>
    <div class="background-animation"></div>

    <header>
        <div class="container header-content-wrapper">
            <img src="profile.jpeg" alt="Pierre Meyer" class="profile-pic-header"> <div class="header-text">
                <h1>Pierre Meyer</h1>
                <p>Business Development Manager | Multilingual Professional | Based in Taipei</p>
            </div>
        </div>
    </header>

    <main class="container">
        <h1>Taiwan-Germany Trade Report</h1>

        <div class="kpi-container">
            <div class="kpi">
                <h3>Latest Imports (Trade)</h3>
                <p id="latestImportValue">---</p>
            </div>
            <div class="kpi">
                <h3>Latest Exports (Trade)</h3>
                <p id="latestExportValue">---</p>
            </div>
            <div class="kpi">
                <h3>Latest Trade Balance</h3>
                <p id="latestTradeBalance">---</p>
            </div>
        </div>

        <div class="chart-wrapper">
            <h2 id="chartTitleTrade">Trade Value Over Time (Monthly)</h2>
            <canvas id="tradeChart"></canvas>
        </div>
        <div id="loadingMessage" class="loading-message-placeholder">Loading trade data...</div>
        <div id="errorMessage" class="error-message-placeholder" style="display:none;"></div>

        <div class="chart-wrapper">
            <h2 id="chartTitleYearlyBalance">Yearly Trade Balance (Exports - Imports)</h2>
            <canvas id="yearlyTradeBalanceChart"></canvas>
        </div>
        <div id="loadingYearlyTradeBalance" class="loading-message-placeholder" style="display:none;">Calculating yearly balance...</div>
        <div id="errorYearlyTradeBalance" class="error-message-placeholder" style="display:none;"></div>
        
    </main>
    <footer>
        <div class="container">
            <p>Â© 2025 Pierre Meyer | <a href="mailto:pierremeyer@outlook.de">Contact Me</a></p>
            <p><a href="index.html">Back to Home</a></p>
        </div>
    </footer>

    <script>
        // --- Configuration ---
        const TRADE_IMPORT_FILE_NAME = 'Imports_from_Germany_to_Taiwan_Over_Time.json';
        const TRADE_EXPORT_FILE_NAME = 'Exports_from_Taiwan_to_Germany_Over_Time.json';
        const TRADE_CURRENCY_SYMBOL = '$';
        const TRADE_CURRENCY_CODE = 'USD';
        const ROLLING_AVERAGE_WINDOW = 12; 

        // --- Helper Functions ---
        function formatCurrency(value, symbol) {
            if (isNaN(value) || value === null) return 'N/A';
            return symbol + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function calculateRollingAverage(data, windowSize) {
            const rollingAvg = [];
            if (!data || data.length === 0) return rollingAvg;

            for (let i = 0; i < data.length; i++) {
                if (i < windowSize - 1) {
                    rollingAvg.push(null); 
                } else {
                    let sum = 0;
                    let count = 0; 
                    for (let j = 0; j < windowSize; j++) {
                        if (typeof data[i - j] === 'number' && data[i-j] !== null) {
                           sum += data[i - j];
                           count++;
                        }
                    }
                    rollingAvg.push(count > 0 ? sum / count : null);
                }
            }
            return rollingAvg;
        }

        // --- Trade Data Functions ---
        async function fetchTradeData(fileName) {
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${fileName}`);
                }
                const jsonData = await response.json();
                const datasetKey = Object.keys(jsonData.datasets)[0];
                if (!datasetKey || !jsonData.datasets[datasetKey]) {
                    throw new Error(`Could not find data array in ${fileName} under 'datasets'.`);
                }
                return jsonData.datasets[datasetKey].map(item => ({
                    date: new Date(item.Date),
                    value: parseFloat(item.Value)
                })).sort((a, b) => a.date - b.date);
            } catch (error) {
                console.error(`Error fetching or parsing ${fileName}:`, error);
                throw error;
            }
        }

        function calculateYearlyTradeBalance(importData, exportData) {
            const yearlyData = {}; 

            exportData.forEach(item => {
                const year = item.date.getFullYear().toString();
                if (!yearlyData[year]) {
                    yearlyData[year] = { exports: 0, imports: 0, exportMonths: 0, importMonths: 0 };
                }
                yearlyData[year].exports += item.value;
                yearlyData[year].exportMonths++;
            });

            importData.forEach(item => {
                const year = item.date.getFullYear().toString();
                if (!yearlyData[year]) {
                    yearlyData[year] = { exports: 0, imports: 0, exportMonths: 0, importMonths: 0 };
                }
                yearlyData[year].imports += item.value;
                yearlyData[year].importMonths++;
            });

            const result = {
                labels: [],
                balances: [],
                isPartial: [] 
            };

            const sortedYears = Object.keys(yearlyData).sort();

            for (const year of sortedYears) {
                result.labels.push(year);
                result.balances.push(yearlyData[year].exports - yearlyData[year].imports);
                
                const isLastYearInDataset = year === sortedYears[sortedYears.length -1];
                if (isLastYearInDataset && (yearlyData[year].exportMonths < 12 || yearlyData[year].importMonths < 12)) {
                     result.isPartial.push(true);
                } else {
                     result.isPartial.push(false);
                }
            }
            return result;
        }

        function renderYearlyTradeBalanceChart(yearlyBalanceData) {
            const loadingEl = document.getElementById('loadingYearlyTradeBalance');
            const errorEl = document.getElementById('errorYearlyTradeBalance');
            const canvasEl = document.getElementById('yearlyTradeBalanceChart');

            if (!canvasEl) {
                console.error('Yearly Trade Balance chart canvas element not found!');
                if(errorEl) {
                    errorEl.textContent = 'Chart canvas missing for yearly balance.';
                    errorEl.style.display = 'block';
                }
                if (loadingEl) loadingEl.style.display = 'none';
                return;
            }

            if (loadingEl) loadingEl.style.display = 'none';
            canvasEl.style.display = 'block';


            const ctx = canvasEl.getContext('2d');
            const barColors = yearlyBalanceData.balances.map(balance => balance >= 0 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)');
            const borderColors = yearlyBalanceData.balances.map(balance => balance >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: yearlyBalanceData.labels,
                    datasets: [{
                        label: 'Yearly Trade Balance',
                        data: yearlyBalanceData.balances,
                        backgroundColor: barColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            title: { display: true, text: `Trade Balance (${TRADE_CURRENCY_CODE})`, color: '#c9d1d9' },
                            ticks: {
                                color: '#8b949e',
                                callback: function(value) {
                                    if (Math.abs(value) >= 1e9) return TRADE_CURRENCY_SYMBOL + (value / 1e9).toFixed(1) + 'B';
                                    if (Math.abs(value) >= 1e6) return TRADE_CURRENCY_SYMBOL + (value / 1e6).toFixed(1) + 'M';
                                    return TRADE_CURRENCY_SYMBOL + value.toLocaleString('en-US');
                                }
                            },
                            grid: { color: '#30363d' }
                        },
                        x: {
                            title: { display: true, text: 'Year', color: '#c9d1d9' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleColor: '#fff', bodyColor: '#fff', backgroundColor: 'rgba(0,0,0,0.8)',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y, TRADE_CURRENCY_SYMBOL);
                                    }
                                    const currentYearIndex = context.dataIndex;
                                    if (yearlyBalanceData.isPartial[currentYearIndex]) {
                                         label += ' (Partial Year)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function displayTradeVisualizations() {
            const loadingMessageEl = document.getElementById('loadingMessage');
            const errorMessageEl = document.getElementById('errorMessage');
            const loadingYearlyBalanceEl = document.getElementById('loadingYearlyTradeBalance');
            const errorYearlyBalanceEl = document.getElementById('errorYearlyTradeBalance');
            
            if(loadingMessageEl) loadingMessageEl.style.display = 'block';
            if(loadingYearlyBalanceEl) loadingYearlyBalanceEl.style.display = 'block';
            if(errorMessageEl) errorMessageEl.style.display = 'none';
            if(errorYearlyBalanceEl) errorYearlyBalanceEl.style.display = 'none';

            try {
                const importData = await fetchTradeData(TRADE_IMPORT_FILE_NAME);
                const exportData = await fetchTradeData(TRADE_EXPORT_FILE_NAME);
                
                if(loadingMessageEl) loadingMessageEl.style.display = 'none'; 

                if (!importData.length || !exportData.length) {
                   throw new Error("No trade data points found after processing files.");
                }
                const labels = importData.map(item => item.date); 
                const importValues = importData.map(item => item.value);
                const exportValues = exportData.map(item => item.value);

                const importRollingAvg = calculateRollingAverage(importValues, ROLLING_AVERAGE_WINDOW);
                const exportRollingAvg = calculateRollingAverage(exportValues, ROLLING_AVERAGE_WINDOW);

                const latestImport = importData[importData.length - 1];
                const latestExport = exportData[exportData.length - 1];
                if(document.getElementById('latestImportValue')) document.getElementById('latestImportValue').textContent = formatCurrency(latestImport.value, TRADE_CURRENCY_SYMBOL);
                if(document.getElementById('latestExportValue')) document.getElementById('latestExportValue').textContent = formatCurrency(latestExport.value, TRADE_CURRENCY_SYMBOL);
                if(document.getElementById('latestTradeBalance')) document.getElementById('latestTradeBalance').textContent = formatCurrency(latestExport.value - latestImport.value, TRADE_CURRENCY_SYMBOL);
                
                const monthlyChartCanvas = document.getElementById('tradeChart');
                if (monthlyChartCanvas) {
                    const ctxMonthly = monthlyChartCanvas.getContext('2d');
                    new Chart(ctxMonthly, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Imports from Germany', data: importValues,
                                    borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    tension: 0.1, fill: true, pointRadius: 2, 
                                    pointBackgroundColor: 'rgba(255, 99, 132, 1)', pointBorderColor: '#fff'
                                },
                                {
                                    label: `Imports (${ROLLING_AVERAGE_WINDOW}-Month Avg)`, data: importRollingAvg,
                                    borderColor: 'rgba(255, 99, 132, 0.7)', borderWidth: 2,
                                    fill: false, tension: 0.1, pointRadius: 0,
                                },
                                {
                                    label: 'Exports to Germany', data: exportValues,
                                    borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    tension: 0.1, fill: true, pointRadius: 2,
                                    pointBackgroundColor: 'rgba(54, 162, 235, 1)', pointBorderColor: '#fff'
                                },
                                {
                                    label: `Exports (${ROLLING_AVERAGE_WINDOW}-Month Avg)`, data: exportRollingAvg,
                                    borderColor: 'rgba(54, 162, 235, 0.7)', borderWidth: 2,
                                    fill: false, tension: 0.1, pointRadius: 0,
                                }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: true,
                            scales: {
                                x: { type: 'time', time: { unit: 'year', tooltipFormat: 'MMM yy', displayFormats: { month: 'MMM yy', year: 'yyyy' }}, 
                                    title: { display: true, text: 'Date', color: '#c9d1d9'},
                                    ticks: {color: '#8b949e'}, grid: {color: '#30363d'}
                                  },
                                y: { beginAtZero: true, 
                                    title: { display: true, text: `Trade Value (${TRADE_CURRENCY_CODE})` , color: '#c9d1d9'}, 
                                    ticks: {color: '#8b949e', callback: function(value) {
                                        if (Math.abs(value) >= 1e9) return TRADE_CURRENCY_SYMBOL + (value / 1e9).toFixed(1) + 'B';
                                        if (Math.abs(value) >= 1e6) return TRADE_CURRENCY_SYMBOL + (value / 1e6).toFixed(1) + 'M';
                                        return TRADE_CURRENCY_SYMBOL + value.toLocaleString('en-US');
                                    }}, 
                                    grid: {color: '#30363d'}
                                }
                            },
                            plugins: {
                                tooltip: { mode: 'index', intersect: false, titleColor: '#fff', bodyColor: '#fff', backgroundColor: 'rgba(0,0,0,0.8)', callbacks: { label: context => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y, TRADE_CURRENCY_SYMBOL)}` }},
                                legend: { position: 'top', labels: {color: '#c9d1d9'} }
                            }
                        }
                    });
                } else {
                    console.error("Monthly trade chart canvas not found!");
                }

                const yearlyBalanceData = calculateYearlyTradeBalance(importData, exportData);
                if (yearlyBalanceData.labels.length > 0) {
                    renderYearlyTradeBalanceChart(yearlyBalanceData);
                } else {
                    if(errorYearlyBalanceEl) {
                        errorYearlyBalanceEl.textContent = 'Not enough data for yearly balance chart.';
                        errorYearlyBalanceEl.style.display = 'block';
                    }
                   if(loadingYearlyBalanceEl) loadingYearlyBalanceEl.style.display = 'none';
                }

            } catch (error) {
                console.error("Failed to display trade visualizations:", error);
                if(loadingMessageEl) loadingMessageEl.style.display = 'none';
                if(errorMessageEl) {
                    errorMessageEl.textContent = `Error loading trade data: ${error.message}.`;
                    errorMessageEl.style.display = 'block';
                }
                if(loadingYearlyBalanceEl) loadingYearlyBalanceEl.style.display = 'none';
                if(errorYearlyBalanceEl) {
                     errorYearlyBalanceEl.textContent = `Could not generate yearly balance chart: ${error.message}`;
                     errorYearlyBalanceEl.style.display = 'block';
                }
            }
        }

        // --- Initial Load ---
        async function initializePage() {
            try {
                await displayTradeVisualizations(); 
            } catch (tradeError) {
                console.error("Error during trade visualizations.", tradeError);
            }
        }

        initializePage();
    </script>
</body>
</html>
